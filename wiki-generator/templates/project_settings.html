{% extends "base.html" %}

{% block title %}Settings - {{ project.name }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Project Settings</h1>
        <p class="card-description">Update connection credentials for {{ project.name }}.</p>
    </div>

    <form method="POST" action="{{ url_for('project_settings', project_id=project_id) }}">
        <div class="form-group">
            <label class="form-label" for="name">Project Name</label>
            <input type="text" id="name" name="name" class="form-input"
                   value="{{ project.name }}" required>
        </div>

        {% if project.platform == 'confluence' %}
        <div class="form-group">
            <label class="form-label" for="base_url">Confluence Base URL</label>
            <input type="text" id="base_url" name="base_url" class="form-input"
                   value="{{ project.base_url }}" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="space_key">Space Key</label>
            <input type="text" id="space_key" name="space_key" class="form-input"
                   value="{{ project.space_key }}" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="user_email">User Email</label>
            <input type="email" id="user_email" name="user_email" class="form-input"
                   value="{{ project.user_email }}" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="api_token">API Token</label>
            <input type="password" id="api_token" name="api_token" class="form-input"
                   placeholder="Leave blank to keep current token">
            <p class="form-hint">Only fill this in if you want to change the token.</p>
        </div>
        {% else %}
        <div class="form-group">
            <label class="form-label" for="wiki_domain">Wiki Domain</label>
            <input type="text" id="wiki_domain" name="wiki_domain" class="form-input"
                   value="{{ project.wiki_domain }}" required>
            <p class="form-hint">e.g., yourwiki.miraheze.org</p>
        </div>

        <div class="form-group">
            <label class="form-label" for="bot_username">Bot Username</label>
            <input type="text" id="bot_username" name="bot_username" class="form-input"
                   value="{{ project.bot_username }}" required>
            <p class="form-hint">Format: Username@BotName (from Special:BotPasswords)</p>
        </div>

        <div class="form-group">
            <label class="form-label" for="bot_password">Bot Password</label>
            <input type="password" id="bot_password" name="bot_password" class="form-input"
                   placeholder="Leave blank to keep current password">
            <p class="form-hint">Only fill this in if you want to change the password.</p>
        </div>
        {% endif %}

        <button type="button" id="test-connection" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Test Connection
        </button>

        <div id="connection-result" class="connection-test" style="display: none;">
            <div class="connection-test-status" id="connection-status">
                <span class="status-icon"></span>
                <span class="status-text"></span>
            </div>
            <div class="connection-test-details" id="connection-details"></div>
        </div>

        <div class="btn-group btn-group-between" style="margin-top: 24px;">
            <a href="{{ url_for('project_structure', project_id=project_id) }}" class="btn btn-secondary">Back to Structure</a>
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testBtn = document.getElementById('test-connection');
    const resultDiv = document.getElementById('connection-result');
    const statusDiv = document.getElementById('connection-status');
    const detailsDiv = document.getElementById('connection-details');

    testBtn.addEventListener('click', async function() {
        const platform = '{{ project.platform }}';
        let payload = { platform };

        {% if project.platform == 'confluence' %}
        payload = {
            platform,
            base_url: document.getElementById('base_url').value,
            space_key: document.getElementById('space_key').value,
            user_email: document.getElementById('user_email').value,
            api_token: document.getElementById('api_token').value || '{{ project.api_token }}'
        };
        {% else %}
        payload = {
            platform,
            wiki_domain: document.getElementById('wiki_domain').value,
            bot_username: document.getElementById('bot_username').value,
            bot_password: document.getElementById('bot_password').value || '{{ project.bot_password }}'
        };
        {% endif %}

        testBtn.disabled = true;
        testBtn.classList.add('btn-loading');
        resultDiv.style.display = 'block';
        statusDiv.className = 'connection-test-status loading';
        statusDiv.innerHTML = '<span class="status-icon">⏳</span> Testing connection...';
        detailsDiv.textContent = '';

        try {
            const response = await fetch('{{ url_for("test_connection") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.success) {
                statusDiv.className = 'connection-test-status success';
                statusDiv.innerHTML = '<span class="status-icon">✓</span> Connection successful!';
                detailsDiv.innerHTML = `
                    <strong>Wiki:</strong> ${data.site_name || 'Unknown'}<br>
                    <strong>API:</strong> Accessible<br>
                    <strong>Login:</strong> Success<br>
                    <strong>Edit Permission:</strong> ${data.edit_permission ? 'Yes' : 'Limited'}
                `;
            } else {
                statusDiv.className = 'connection-test-status error';
                statusDiv.innerHTML = '<span class="status-icon">✗</span> Connection failed';
                detailsDiv.textContent = data.error || 'Unknown error occurred';
            }
        } catch (error) {
            statusDiv.className = 'connection-test-status error';
            statusDiv.innerHTML = '<span class="status-icon">✗</span> Connection failed';
            detailsDiv.textContent = 'Network error: ' + error.message;
        }

        testBtn.disabled = false;
        testBtn.classList.remove('btn-loading');
    });
});
</script>
{% endblock %}
