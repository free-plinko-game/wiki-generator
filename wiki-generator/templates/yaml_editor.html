{% extends "base.html" %}

{% set step = 2 %}
{% set total_steps = 5 %}
{% set step_labels = ['Setup', 'Structure', 'Generate', 'Review', 'Complete'] %}

{% block title %}Structure Editor - {{ project.name }}{% endblock %}

{% block head %}
<style>
    .yaml-editor-container { min-height: 600px; }
    .live-pages-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .live-page-item { width: 100%; background: var(--color-bg); border: 1px solid var(--color-border); text-align: left; }
    .live-page-item.active { border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
    .live-page-item svg { flex-shrink: 0; }
    .live-html-preview { background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 16px; max-height: 360px; overflow-y: auto; }
    .live-page-editor textarea { min-height: 220px; }
    @media (max-width: 900px) {
        .live-pages-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Build Wiki Structure</h1>
        <p class="card-description">Define your wiki pages, categories, and key points. The AI will generate content based on this structure.</p>
    </div>

    <div class="form-group">
        <label class="form-label" for="wiki_name">Wiki Name</label>
        <input type="text" id="wiki_name" class="form-input"
               placeholder="e.g., Australian Gambling Encyclopaedia"
               value="{{ pages_config.wiki_name if pages_config else '' }}">
    </div>

    <div class="form-group">
        <label class="form-label" for="default_category">Default Category</label>
        <input type="text" id="default_category" class="form-input"
               placeholder="e.g., General"
               value="{{ pages_config.default_category if pages_config else 'General' }}">
    </div>
</div>

<div class="yaml-editor-container">
    <div class="yaml-builder">
        <div class="yaml-builder-header">
            <h3 class="yaml-builder-title">Pages</h3>
            <button type="button" class="btn btn-primary btn-sm" id="add-page">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M7 2V12M2 7H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Add Page
            </button>
        </div>
        <div class="yaml-builder-content" id="pages-container">
            <!-- Pages will be added here dynamically -->
        </div>
    </div>

    <div class="yaml-preview">
        <div class="yaml-preview-header">
            <h3 class="yaml-builder-title">YAML Preview</h3>
            <button type="button" class="btn btn-secondary btn-sm" id="download-yaml">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M7 2V9M7 9L4 6M7 9L10 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 11H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Download
            </button>
        </div>
        <div class="yaml-preview-content">
            <pre id="yaml-output">Loading...</pre>
        </div>
        <div style="padding: 20px; border-top: 1px solid var(--color-border);">
            <h4 class="yaml-builder-title" style="margin-bottom: 8px;">Import YAML</h4>
            <textarea id="yaml-import-input" class="form-textarea" placeholder="Paste your pages.yaml here" rows="8"></textarea>
            <div class="btn-group btn-group-right" style="margin-top: 12px;">
                <button type="button" class="btn btn-secondary btn-sm" id="clear-yaml-import">Clear</button>
                <button type="button" class="btn btn-primary btn-sm" id="apply-yaml-import">Apply YAML</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
        <div>
            <h2 class="card-title">Live Wiki Pages</h2>
            <p class="card-description">Fetch the current pages from your wiki to cross-check structure.</p>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="refresh-live-pages">
            Refresh
        </button>
    </div>
    <div class="live-pages-grid">
        <div>
            <div id="live-pages-status" class="form-hint">Not loaded yet.</div>
            <div id="live-pages-list" class="page-list"></div>
        </div>
        <div class="live-page-editor">
            <div class="form-group">
                <label class="form-label" for="live-page-title">Page Title</label>
                <input type="text" id="live-page-title" class="form-input" placeholder="Select a page to edit">
            </div>
            <div class="form-group">
                <label class="form-label" for="live-page-summary">Edit Summary</label>
                <input type="text" id="live-page-summary" class="form-input" value="Updated via Wiki Generator">
            </div>
            <div class="form-group">
                <label class="form-label" for="live-page-content">Wiki Markup</label>
                <textarea id="live-page-content" class="form-textarea" placeholder="Select a page to load content"></textarea>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" id="refresh-live-preview">Update Preview</button>
                <button type="button" class="btn btn-primary" id="save-live-page">Save to Wiki</button>
            </div>
            <div id="live-page-message" class="form-hint"></div>
        </div>
    </div>
    <div style="margin-top: 24px;">
        <h3 class="yaml-builder-title" style="margin-bottom: 12px;">HTML Preview</h3>
        <div id="live-page-preview" class="live-html-preview"></div>
    </div>
</div>

<div class="btn-group btn-group-between" style="margin-top: 24px;">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
    <div style="display: flex; gap: 12px;">
        <button type="button" class="btn btn-secondary" id="save-structure">Save Draft</button>
        <button type="button" class="btn btn-primary" id="continue-btn">
            Continue to Generate
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M3 8H13M13 8L9 4M13 8L9 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
</div>

<!-- Page Template (hidden) -->
<template id="page-template">
    <div class="page-item" data-page-index="">
        <div class="page-item-header">
            <div class="page-item-title">
                <svg class="page-item-expand" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="page-title-text">New Page</span>
            </div>
            <div class="page-item-actions">
                <button type="button" class="btn btn-ghost btn-icon btn-sm move-up" title="Move Up">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M7 11V3M7 3L3 7M7 3L11 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button type="button" class="btn btn-ghost btn-icon btn-sm move-down" title="Move Down">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M7 3V11M7 11L3 7M7 11L11 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button type="button" class="btn btn-ghost btn-icon btn-sm delete-page" title="Delete">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M2 4H12M5 4V3C5 2.44772 5.44772 2 6 2H8C8.55228 2 9 2.44772 9 3V4M11 4V11C11 11.5523 10.5523 12 10 12H4C3.44772 12 3 11.5523 3 11V4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="page-item-content">
            <div class="form-group">
                <label class="form-label">Page Title</label>
                <input type="text" class="form-input page-title-input" placeholder="e.g., BetStop National Self-Exclusion">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" class="form-input page-category-input" placeholder="e.g., Self-Exclusion">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea page-description-input" rows="2" placeholder="Brief description of what this page should cover"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Key Points</label>
                <div class="key-points-list">
                    <!-- Key points added dynamically -->
                </div>
                <button type="button" class="btn btn-secondary btn-sm add-key-point" style="margin-top: 8px;">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M7 2V12M2 7H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Add Key Point
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Related Pages <span class="form-label-optional">(comma-separated)</span></label>
                <input type="text" class="form-input page-related-input" placeholder="e.g., BetStop How to Register, State Self-Exclusion Schemes">
            </div>
        </div>
    </div>
</template>

<!-- Key Point Template -->
<template id="key-point-template">
    <div class="key-point-item">
        <input type="text" class="form-input key-point-input" placeholder="Enter a key point">
        <button type="button" class="btn btn-ghost btn-icon btn-sm remove-key-point">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                <path d="M3 7H11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/yaml_editor.js') }}"></script>
<script>
    // Initialize with existing data if available
    const existingConfig = {{ pages_config | tojson | safe if pages_config else 'null' }};
    const projectId = '{{ project.id }}';
    const saveUrl = '{{ url_for("save_structure", project_id=project.id) }}';
    const generateUrl = '{{ url_for("project_generate", project_id=project.id) }}';
    const importUrl = '{{ url_for("import_structure", project_id=project.id) }}';
    const livePagesUrl = '{{ url_for("project_live_pages", project_id=project.id) }}';
    const livePageUrl = '{{ url_for("project_live_page_content", project_id=project.id) }}';
    const livePreviewUrl = '{{ url_for("project_live_page_preview", project_id=project.id) }}';
    const liveSaveUrl = '{{ url_for("project_live_page_save", project_id=project.id) }}';

    initYamlEditor(existingConfig, projectId, saveUrl, generateUrl, importUrl);

    const livePagesBtn = document.getElementById('refresh-live-pages');
    const livePagesStatus = document.getElementById('live-pages-status');
    const livePagesList = document.getElementById('live-pages-list');
    const livePageTitle = document.getElementById('live-page-title');
    const livePageSummary = document.getElementById('live-page-summary');
    const livePageContent = document.getElementById('live-page-content');
    const livePagePreview = document.getElementById('live-page-preview');
    const livePageMessage = document.getElementById('live-page-message');
    const livePreviewBtn = document.getElementById('refresh-live-preview');
    const liveSaveBtn = document.getElementById('save-live-page');

    let currentLiveTitle = '';
    let lastSyncedTitle = '';

    function setLivePagesStatus(message, isError = false) {
        livePagesStatus.textContent = message;
        livePagesStatus.style.color = isError ? 'var(--color-error)' : '';
    }

    function renderLivePages(pages) {
        livePagesList.innerHTML = '';
        if (!pages.length) {
            setLivePagesStatus('No pages found on the wiki.', false);
            return;
        }

        pages.forEach((title) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'page-list-item live-page-item';

            const info = document.createElement('div');
            info.className = 'page-list-item-info';

            const name = document.createElement('span');
            name.className = 'page-list-item-title';
            name.textContent = title;

            info.appendChild(name);
            item.appendChild(info);
            livePagesList.appendChild(item);

            item.addEventListener('click', () => loadLivePage(title, item));
        });
    }

    function setLivePageMessage(message, isError = false) {
        livePageMessage.textContent = message;
        livePageMessage.style.color = isError ? 'var(--color-error)' : '';
    }

    function setActiveLiveItem(activeItem) {
        document.querySelectorAll('.live-page-item').forEach(item => {
            item.classList.toggle('active', item === activeItem);
        });
    }

    async function loadLivePage(title, item) {
        setActiveLiveItem(item);
        setLivePageMessage('Loading page content...', false);
        livePagePreview.innerHTML = '';

        try {
            const response = await fetch(`${livePageUrl}?title=${encodeURIComponent(title)}`);
            const data = await response.json();

            if (!data.success) {
                setLivePageMessage(data.error || 'Failed to load page.', true);
                return;
            }

            currentLiveTitle = data.title;
            lastSyncedTitle = data.title;
            livePageTitle.value = data.title;
            livePageContent.value = data.content || '';
            livePagePreview.innerHTML = data.html || '';

            if (window.syncTitleToYaml) {
                window.syncTitleToYaml('', data.title);
            }

            setLivePageMessage('Loaded.', false);
        } catch (error) {
            setLivePageMessage(`Error: ${error.message}`, true);
        }
    }

    async function fetchLivePages() {
        livePagesBtn.disabled = true;
        livePagesBtn.classList.add('btn-loading');
        setLivePagesStatus('Loading pages from the wiki...', false);

        try {
            const response = await fetch(`${livePagesUrl}?limit=500`, { method: 'GET' });
            const data = await response.json();

            if (!data.success) {
                setLivePagesStatus(data.error || 'Failed to load live pages.', true);
                livePagesList.innerHTML = '';
                return;
            }

            setLivePagesStatus(`Loaded ${data.count} page(s).`, false);
            renderLivePages(data.pages || []);
        } catch (error) {
            setLivePagesStatus(`Error: ${error.message}`, true);
            livePagesList.innerHTML = '';
        } finally {
            livePagesBtn.disabled = false;
            livePagesBtn.classList.remove('btn-loading');
        }
    }

    livePagesBtn.addEventListener('click', fetchLivePages);
    fetchLivePages();

    const syncLiveTitle = debounce(() => {
        const newTitle = livePageTitle.value.trim();
        if (window.syncTitleToYaml) {
            window.syncTitleToYaml(lastSyncedTitle, newTitle);
        }
        lastSyncedTitle = newTitle;
    }, 300);

    livePageTitle.addEventListener('input', syncLiveTitle);

    livePreviewBtn.addEventListener('click', async () => {
        const title = livePageTitle.value.trim();
        const content = livePageContent.value;

        if (!content.trim()) {
            setLivePageMessage('Add content to preview.', true);
            return;
        }

        livePreviewBtn.disabled = true;
        livePreviewBtn.classList.add('btn-loading');
        setLivePageMessage('Updating preview...', false);

        try {
            const response = await fetch(livePreviewUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });
            const data = await response.json();
            if (!data.success) {
                setLivePageMessage(data.error || 'Failed to render preview.', true);
                return;
            }

            livePagePreview.innerHTML = data.html || '';
            setLivePageMessage('Preview updated.', false);
        } catch (error) {
            setLivePageMessage(`Error: ${error.message}`, true);
        } finally {
            livePreviewBtn.disabled = false;
            livePreviewBtn.classList.remove('btn-loading');
        }
    });

    liveSaveBtn.addEventListener('click', async () => {
        const title = livePageTitle.value.trim();
        const content = livePageContent.value;
        const summary = livePageSummary.value.trim() || 'Updated via Wiki Generator';

        if (!title) {
            setLivePageMessage('Title is required to save.', true);
            return;
        }

        liveSaveBtn.disabled = true;
        liveSaveBtn.classList.add('btn-loading');
        setLivePageMessage('Saving to wiki...', false);

        try {
            const response = await fetch(liveSaveUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content, summary })
            });
            const data = await response.json();
            if (!data.success) {
                setLivePageMessage(data.error || 'Failed to save page.', true);
                return;
            }

            currentLiveTitle = data.title;
            livePagePreview.innerHTML = data.html || '';
            setLivePageMessage('Saved.', false);
        } catch (error) {
            setLivePageMessage(`Error: ${error.message}`, true);
        } finally {
            liveSaveBtn.disabled = false;
            liveSaveBtn.classList.remove('btn-loading');
        }
    });
</script>
{% endblock %}
