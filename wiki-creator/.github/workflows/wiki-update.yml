name: Update Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'content/**'
      - 'pages.yaml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual uploads)'
        required: false
        default: 'false'
        type: boolean
      regenerate:
        description: 'Regenerate content with OpenAI before upload'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Regenerate content with OpenAI
        if: ${{ github.event.inputs.regenerate == 'true' }}
        run: |
          python scripts/generate_content.py ./content
          echo "Content regenerated with OpenAI"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Test wiki connection
        run: |
          python scripts/wiki_bot.py --test
        env:
          WIKI_DOMAIN: ${{ secrets.WIKI_DOMAIN }}
          WIKI_BOT_USERNAME: ${{ secrets.WIKI_BOT_USERNAME }}
          WIKI_BOT_PASSWORD: ${{ secrets.WIKI_BOT_PASSWORD }}

      - name: Upload content to wiki
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          python scripts/wiki_bot.py --upload ./content
        env:
          WIKI_DOMAIN: ${{ secrets.WIKI_DOMAIN }}
          WIKI_BOT_USERNAME: ${{ secrets.WIKI_BOT_USERNAME }}
          WIKI_BOT_PASSWORD: ${{ secrets.WIKI_BOT_PASSWORD }}

      - name: Dry run (no upload)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          python scripts/wiki_bot.py --upload ./content --dry-run
        env:
          WIKI_DOMAIN: ${{ secrets.WIKI_DOMAIN }}
          WIKI_BOT_USERNAME: ${{ secrets.WIKI_BOT_USERNAME }}
          WIKI_BOT_PASSWORD: ${{ secrets.WIKI_BOT_PASSWORD }}

      - name: Summary
        run: |
          echo "## Wiki Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Wiki:** https://${{ secrets.WIKI_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d content ] && [ "$(ls -A content/*.wiki 2>/dev/null)" ]; then
            echo "**Pages:**" >> $GITHUB_STEP_SUMMARY
            ls -1 content/*.wiki | wc -l >> $GITHUB_STEP_SUMMARY
          else
            echo "**Pages:** No .wiki files found" >> $GITHUB_STEP_SUMMARY
          fi

  validate-pages-yaml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate pages.yaml
        run: |
          python -c "
          import yaml
          import sys

          with open('pages.yaml', 'r') as f:
              config = yaml.safe_load(f)

          pages = config.get('pages', [])
          print(f'Found {len(pages)} pages configured')

          errors = []
          for i, page in enumerate(pages):
              if 'title' not in page:
                  errors.append(f'Page {i+1}: missing title')
              if 'description' not in page:
                  errors.append(f'Page {i+1} ({page.get(\"title\", \"unknown\")}): missing description')
              if 'key_points' not in page or not page['key_points']:
                  errors.append(f'Page {i+1} ({page.get(\"title\", \"unknown\")}): missing key_points')

          if errors:
              print('Validation errors:')
              for e in errors:
                  print(f'  - {e}')
              sys.exit(1)

          print('All pages valid!')
          for page in pages:
              print(f'  - [{page.get(\"category\", \"General\")}] {page[\"title\"]}')
          "
